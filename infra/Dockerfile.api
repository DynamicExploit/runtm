FROM python:3.12-slim

# Create non-root user early
# SECURITY: Running as non-root prevents container escape attacks
RUN useradd --create-home --uid 1000 --shell /bin/bash runtm

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install flyctl for runtime log access
RUN curl -L https://fly.io/install.sh | sh
ENV FLYCTL_INSTALL="/root/.fly"
ENV PATH="$FLYCTL_INSTALL/bin:$PATH"

# Copy package files
COPY packages/shared/pyproject.toml packages/shared/README.md packages/shared/
COPY packages/shared/runtm_shared packages/shared/runtm_shared/

COPY packages/worker/pyproject.toml packages/worker/README.md packages/worker/
COPY packages/worker/runtm_worker packages/worker/runtm_worker/

COPY packages/api/pyproject.toml packages/api/README.md packages/api/
COPY packages/api/runtm_api packages/api/runtm_api/
COPY packages/api/alembic packages/api/alembic/
COPY packages/api/alembic.ini packages/api/

# Install packages (include worker for FlyProvider access in destroy endpoint)
RUN pip install --no-cache-dir ./packages/shared ./packages/worker ./packages/api

# Set working directory for API
WORKDIR /app/packages/api

# Create artifacts directory with correct ownership
RUN mkdir -p /artifacts && chown -R runtm:runtm /artifacts /app

# Copy entrypoint script
COPY --chown=runtm:runtm infra/entrypoint-api.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# Switch to non-root user
USER runtm

# Expose port
EXPOSE 8000

# Run migrations and start server via entrypoint
CMD ["/app/entrypoint.sh"]
